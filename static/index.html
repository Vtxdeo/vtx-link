<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTX Link Admin</title>
    <style>
        :root { --primary: #0078d4; --bg: #f8f9fa; --text: #323130; --border: #edebe9; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; line-height: 1.5; }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .header { background: #201f1e; color: white; padding: 0 20px; height: 50px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-title { font-weight: 600; font-size: 16px; letter-spacing: 0.5px; }
        .sys-stat { font-size: 13px; color: #d0d0d0; font-family: monospace; }

        /* ä¸»å®¹å™¨ */
        .container { padding: 20px; max-width: 900px; margin: auto; }

        /* å¡ç‰‡æ ·å¼ */
        .card { background: white; border: 1px solid var(--border); border-left: 4px solid transparent; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: all 0.2s; border-radius: 4px; }
        .card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.05); }

        /* çŠ¶æ€è¾¹æ¡†é¢œè‰² */
        .card.status-running { border-left-color: #107c10; }
        .card.status-stopped { border-left-color: #a19f9d; }
        .card.status-crashed { border-left-color: #d13438; }

        /* å¾½ç«  */
        .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; margin-left: 8px; vertical-align: middle; }
        .badge.run { background: #dff6dd; color: #107c10; }
        .badge.stop { background: #f3f2f1; color: #605e5c; }
        .badge.crash { background: #fde7e9; color: #a4262c; }

        /* æ–‡æœ¬æ’ç‰ˆ */
        .stream-name { font-weight: 600; font-size: 15px; display: flex; align-items: center; }
        .stream-meta { font-size: 12px; color: #605e5c; margin-top: 6px; }
        .meta-item { margin-right: 15px; display: inline-flex; align-items: center; }
        .meta-icon { margin-right: 4px; opacity: 0.7; }

        /* æŒ‰é’®ç»„ */
        .btn-group { display: flex; gap: 8px; }
        .btn { border: none; padding: 6px 16px; cursor: pointer; border-radius: 3px; font-size: 13px; font-weight: 500; transition: background 0.1s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #005a9e; }

        .btn-danger { background: #fde7e9; color: #a4262c; }
        .btn-danger:hover { background: #fdd9db; }

        /* åŠ è½½ä¸é”™è¯¯æç¤º */
        .loading { text-align: center; color: #605e5c; padding: 40px; }
        .error-msg { background: #fde7e9; color: #a4262c; padding: 10px; border-radius: 4px; margin-bottom: 20px; text-align: center; display: none; }
    </style>
</head>
<body>
<div class="header">
    <div class="header-title">VTX Link <span style="font-weight:400; opacity:0.7">| Edge Gateway</span></div>
    <div class="sys-stat" id="mem-info">Connecting...</div>
</div>

<div class="container">
    <div id="error-banner" class="error-msg"></div>
    <div id="stream-list">
        <div class="loading">æ­£åœ¨è¿æ¥ç½‘å…³...</div>
    </div>
</div>

<script>
    // æ ¼å¼åŒ–æ—¶é—´è¾…åŠ©å‡½æ•° (ç§’ -> æ˜“è¯»æ ¼å¼)
    function formatTime(seconds) {
        if (seconds < 60) return `${seconds}s`;
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return (h > 0 ? `${h}h ` : "") + (m > 0 ? `${m}m ` : "") + `${s}s`;
    }

    // çŠ¶æ€æ˜ å°„è¾…åŠ©å‡½æ•°
    function getStatusClass(s) {
        if (s.status === 'running') return 'status-running';
        if (s.crash_count > 0 && s.status !== 'running') return 'status-crashed';
        return 'status-stopped';
    }

    async function update() {
        try {
            // 1. è·å–æµåˆ—è¡¨æ•°æ®
            const sRes = await fetch('/streams');
            if (!sRes.ok) throw new Error("API Error");
            const { streams } = await sRes.json();

            // 2. æ¸²æŸ“æµå¡ç‰‡
            const html = streams.map(s => {
                // æ„å»ºå¾½ç« 
                let badges = '';
                if (s.status === 'running') {
                    badges += `<span class="badge run">RUNNING</span>`;
                } else {
                    badges += `<span class="badge stop">STOPPED</span>`;
                }

                // å´©æºƒè­¦å‘Šå¾½ç« 
                if (s.crash_count > 0) {
                    badges += `<span class="badge crash">CRASH: ${s.crash_count}</span>`;
                }

                // æ„å»ºè¯¦æƒ…è¡Œ
                let details = `
                    <span class="meta-item" title="Source URL">ğŸ“º ${s.source}</span>
                `;

                if (s.status === 'running') {
                    details += `
                        <br>
                        <span class="meta-item" title="Uptime">â±ï¸ è¿è¡Œæ—¶é•¿: ${formatTime(s.uptime_seconds)}</span>
                        <span class="meta-item" title="Idle Time">ğŸ’¤ é—²ç½®: ${s.idle_seconds}s / ${s.config_idle_timeout}s</span>
                    `;
                }

                return `
                    <div class="card ${getStatusClass(s)}">
                        <div>
                            <div class="stream-name">${s.name} ${badges}</div>
                            <div class="stream-meta">${details}</div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="act('${s.name}','start')">
                                ${s.status === 'running' ? 'é‡å¯ / åˆ·æ–°' : 'å¯åŠ¨'}
                            </button>
                            <button class="btn btn-danger" onclick="act('${s.name}','stop')">åœæ­¢</button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('stream-list').innerHTML = html;
            document.getElementById('error-banner').style.display = 'none';

            // 3. è·å–ç³»ç»Ÿèµ„æºçŠ¶æ€
            const mRes = await fetch('/sys/status');
            if (mRes.ok) {
                const m = await mRes.json();
                // ç®€å•çš„å†…å­˜æ¡å¯è§†åŒ–
                const memPercent = Math.round(((m.mem_total - m.mem_avail) / m.mem_total) * 100);
                document.getElementById('mem-info').innerHTML = `
                        RAM: ${m.mem_avail}MB Free | Load: ${m.load_avg.toFixed(2)}
                    `;
            }

        } catch (e) {
            console.error("Connection lost", e);
            document.getElementById('error-banner').innerText = "æ— æ³•è¿æ¥åˆ°ç½‘å…³æœåŠ¡ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡çŠ¶æ€ã€‚";
            document.getElementById('error-banner').style.display = 'block';
            document.getElementById('mem-info').innerText = "OFFLINE";
        }
    }

    // æŒ‰é’®æ“ä½œé€»è¾‘
    async function act(name, op) {
        try {
            // æ·»åŠ ç®€å•çš„ç‚¹å‡»åé¦ˆ
            const btn = event.target;
            const originText = btn.innerText;
            btn.innerText = "...";
            btn.disabled = true;

            await fetch(`/streams/${name}/${op}`, { method: 'POST' });

            // æ“ä½œåç«‹å³åˆ·æ–°ä¸€æ¬¡
            await update();
        } catch (e) {
            alert("æ“ä½œå¤±è´¥: " + e);
        }
    }

    // å¯åŠ¨è½®è¯¢
    setInterval(update, 2000);
    // é¦–æ¬¡åŠ è½½
    update();
</script>
</body>
</html>
